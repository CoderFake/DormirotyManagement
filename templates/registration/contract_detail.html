{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Chi tiết hợp đồng #{{ contract.contract_number }} - Quản lý Ký túc xá{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Chi tiết hợp đồng #{{ contract.contract_number }}</h6>
            <div>
                {% if is_admin %}
                    <a href="{% url 'registration:contract_list' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Danh sách hợp đồng
                    </a>
                {% else %}
                    <a href="{% url 'registration:my_contracts' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Hợp đồng của tôi
                    </a>
                {% endif %}

                <div class="btn-group ms-2">
                    <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i> Thao tác
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                        {% if is_admin %}
                            {% if not contract.signed_by_admin %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'registration:contract_approve' contract.id %}">
                                        <i class="fas fa-signature me-1 text-success"></i> Ký duyệt hợp đồng
                                    </a>
                                </li>
                            {% endif %}

                            {% if not check_in %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'registration:check_in_create' contract.id %}">
                                        <i class="fas fa-clipboard-check me-1 text-primary"></i> Tạo biên bản nhận phòng
                                    </a>
                                </li>
                            {% endif %}

                            {% if not check_out and contract.status == 'active' %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'registration:check_out_create' contract.id %}">
                                        <i class="fas fa-door-open me-1 text-warning"></i> Tạo biên bản trả phòng
                                    </a>
                                </li>
                            {% endif %}

                            <li><hr class="dropdown-divider"></li>

                            <li>
                                <a class="dropdown-item" href="#" onclick="printContract()">
                                    <i class="fas fa-print me-1 text-info"></i> In hợp đồng
                                </a>
                            </li>
                        {% else %}
                            {% if not contract.signed_by_student %}
                                <li>
                                    <a class="dropdown-item" href="{% url 'registration:sign_contract' contract.id %}">
                                        <i class="fas fa-signature me-1 text-success"></i> Ký hợp đồng
                                    </a>
                                </li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="#" onclick="printContract()">
                                    <i class="fas fa-print me-1 text-info"></i> In hợp đồng
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="row mb-4">
                <!-- Thông tin hợp đồng -->
                <div class="col-md-6">
                    <h5 class="text-primary">Thông tin hợp đồng</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 40%;">Số hợp đồng:</th>
                            <td>{{ contract.contract_number }}</td>
                        </tr>
                        <tr>
                            <th>Ngày bắt đầu:</th>
                            <td>{{ contract.start_date|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>Ngày kết thúc:</th>
                            <td>{{ contract.end_date|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>Phí hàng tháng:</th>
                            <td>{{ contract.monthly_fee|intcomma }} VNĐ</td>
                        </tr>
                        <tr>
                            <th>Tiền đặt cọc:</th>
                            <td>{{ contract.deposit_amount|intcomma }} VNĐ</td>
                        </tr>
                        <tr>
                            <th>Trạng thái:</th>
                            <td>
                                {% if contract.status == 'draft' %}
                                    <span class="badge bg-secondary">Dự thảo</span>
                                {% elif contract.status == 'pending' %}
                                    <span class="badge bg-warning">Chờ ký</span>
                                {% elif contract.status == 'active' %}
                                    <span class="badge bg-success">Đang hiệu lực</span>
                                {% elif contract.status == 'terminated' %}
                                    <span class="badge bg-danger">Đã chấm dứt</span>
                                {% elif contract.status == 'expired' %}
                                    <span class="badge bg-dark">Hết hạn</span>
                                {% elif contract.status == 'canceled' %}
                                    <span class="badge bg-secondary">Đã hủy</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- Thông tin sinh viên -->
                <div class="col-md-6">
                    <h5 class="text-primary">Thông tin sinh viên</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 40%;">Mã sinh viên:</th>
                            <td>{{ contract.user.student_id }}</td>
                        </tr>
                        <tr>
                            <th>Họ và tên:</th>
                            <td>{{ contract.user.full_name }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ contract.user.email }}</td>
                        </tr>
                        <tr>
                            <th>Số điện thoại:</th>
                            <td>{{ contract.user.phone_number|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>CMND/CCCD:</th>
                            <td>{{ contract.user.id_card_number|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="row mb-4">
                <!-- Thông tin phòng ở -->
                <div class="col-md-6">
                    <h5 class="text-primary">Thông tin phòng ở</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 40%;">Tòa nhà:</th>
                            <td>{{ contract.room.building.name }}</td>
                        </tr>
                        <tr>
                            <th>Phòng:</th>
                            <td>{{ contract.room.room_number }}</td>
                        </tr>
                        <tr>
                            <th>Giường:</th>
                            <td>Giường {{ contract.bed.bed_number }}</td>
                        </tr>
                        <tr>
                            <th>Loại phòng:</th>
                            <td>{{ contract.room.room_type.name }}</td>
                        </tr>
                        <tr>
                            <th>Sức chứa:</th>
                            <td>{{ contract.room.room_type.capacity }} người</td>
                        </tr>
                    </table>
                </div>

                <!-- Thông tin xác nhận -->
                <div class="col-md-6">
                    <h5 class="text-primary">Thông tin xác nhận</h5>
                    <table class="table table-bordered">
                        <tr>
                            <th style="width: 40%;">Trạng thái sinh viên:</th>
                            <td>
                                {% if contract.signed_by_student %}
                                    <span class="text-success">
                                        <i class="fas fa-check-circle me-1"></i> Đã ký
                                        {% if contract.student_signed_date %}
                                            ({{ contract.student_signed_date|date:"d/m/Y H:i" }})
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="text-warning">
                                        <i class="fas fa-clock me-1"></i> Chưa ký
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Trạng thái quản trị:</th>
                            <td>
                                {% if contract.signed_by_admin %}
                                    <span class="text-success">
                                        <i class="fas fa-check-circle me-1"></i> Đã ký
                                        {% if contract.admin_signed_date %}
                                            ({{ contract.admin_signed_date|date:"d/m/Y H:i" }})
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <span class="text-warning">
                                        <i class="fas fa-clock me-1"></i> Chưa ký
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Ngày tạo:</th>
                            <td>{{ contract.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                        <tr>
                            <th>Cập nhật cuối:</th>
                            <td>{{ contract.updated_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Điều khoản và điều kiện -->
            <div class="card mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Điều khoản và điều kiện</h6>
                </div>
                <div class="card-body contract-terms">
                    {% if contract.terms_and_conditions %}
                        {{ contract.terms_and_conditions|linebreaks }}
                    {% else %}
                        <h5>HỢP ĐỒNG NỘI TRÚ KÝ TÚC XÁ</h5>

                        <p>Hôm nay, ngày {{ contract.created_at|date:"d" }} tháng {{ contract.created_at|date:"m" }} năm {{ contract.created_at|date:"Y" }}, tại Ký túc xá trường Đại học Bưu chính Viễn thông, chúng tôi gồm:</p>

                        <p><strong>BÊN A: BAN QUẢN LÝ KÝ TÚC XÁ</strong></p>
                        <p>Đại diện: Ông/Bà ...........................................</p>
                        <p>Chức vụ: ...................................................</p>
                        <p>Địa chỉ: ..................................................</p>
                        <p>Điện thoại: ...............................................</p>

                        <p><strong>BÊN B: NGƯỜI THUÊ CHỖ Ở (SINH VIÊN)</strong></p>
                        <p>Họ và tên: {{ contract.user.full_name }}</p>
                        <p>Mã số sinh viên: {{ contract.user.student_id }}</p>
                        <p>Ngày sinh: {{ contract.user.date_of_birth|date:"d/m/Y" }}</p>
                        <p>Số CMND/CCCD: {{ contract.user.id_card_number }}</p>
                        <p>Điện thoại: {{ contract.user.phone_number }}</p>
                        <p>Email: {{ contract.user.email }}</p>

                        <p>Hai bên thống nhất ký hợp đồng thuê chỗ ở nội trú với các điều khoản sau:</p>

                        <p><strong>Điều 1: Bên A cung cấp cho Bên B chỗ ở tại:</strong></p>
                        <p>- Phòng số: {{ contract.room.room_number }}</p>
                        <p>- Tòa nhà: {{ contract.room.building.name }}</p>
                        <p>- Giường số: {{ contract.bed.bed_number }}</p>
                        <p>- Thời hạn từ {{ contract.start_date|date:"d/m/Y" }} đến {{ contract.end_date|date:"d/m/Y" }}</p>

                        <p><strong>Điều 2: Bên B phải thực hiện đầy đủ các khoản thanh toán sau:</strong></p>
                        <p>- Tiền phòng: {{ contract.monthly_fee|intcomma }} VNĐ/tháng</p>
                        <p>- Tiền đặt cọc: {{ contract.deposit_amount|intcomma }} VNĐ</p>
                        <p>- Thanh toán theo định kỳ: hàng tháng, trước ngày 10 của tháng</p>

                        <p><strong>Điều 3: Bên B có trách nhiệm:</strong></p>
                        <ul>
                            <li>Chấp hành nội quy KTX, giữ gìn an ninh, trật tự trong KTX</li>
                            <li>Giữ gìn vệ sinh, bảo quản tài sản trong phòng ở</li>
                            <li>Thanh toán đầy đủ, đúng hạn các khoản phí</li>
                            <li>Không được tự ý sửa chữa, cải tạo phòng ở</li>
                            <li>Bồi thường thiệt hại nếu làm hư hỏng tài sản</li>
                        </ul>

                        <p><strong>Điều 4: Bên A có trách nhiệm:</strong></p>
                        <ul>
                            <li>Đảm bảo cơ sở vật chất, an ninh cho sinh viên</li>
                            <li>Cung cấp đầy đủ điện, nước, dịch vụ theo quy định</li>
                            <li>Sửa chữa kịp thời các hư hỏng thuộc trách nhiệm của BQL</li>
                            <li>Tạo môi trường sống lành mạnh, thân thiện</li>
                        </ul>

                        <p><strong>Điều 5: Chấm dứt hợp đồng</strong></p>
                        <p>Hợp đồng chấm dứt trong các trường hợp sau:</p>
                        <ul>
                            <li>Hết thời hạn ghi trong hợp đồng</li>
                            <li>Sinh viên vi phạm nghiêm trọng nội quy KTX</li>
                            <li>Theo thỏa thuận của hai bên</li>
                        </ul>

                        <p>Hợp đồng được lập thành 02 bản có giá trị pháp lý như nhau, mỗi bên giữ 01 bản.</p>

                        <div class="row mt-5">
                            <div class="col-6 text-center">
                                <p><strong>ĐẠI DIỆN BÊN A</strong></p>
                                {% if contract.signed_by_admin %}
                                    <p class="signature"><i class="fas fa-signature text-primary"></i></p>
                                {% endif %}
                            </div>
                            <div class="col-6 text-center">
                                <p><strong>BÊN B (SINH VIÊN)</strong></p>
                                {% if contract.signed_by_student %}
                                    <p class="signature"><i class="fas fa-signature text-success"></i></p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Ghi chú -->
            {% if contract.notes %}
                <div class="card mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Ghi chú</h6>
                    </div>
                    <div class="card-body">
                        {{ contract.notes|linebreaks }}
                    </div>
                </div>
            {% endif %}

            <!-- Biên bản liên quan -->
            <div class="row">
                <!-- Biên bản nhận phòng -->
                {% if check_in %}
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Biên bản nhận phòng</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 40%;">Ngày nhận phòng:</th>
                                        <td>{{ check_in.check_in_date|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Trạng thái:</th>
                                        <td>
                                            {% if check_in.is_completed %}
                                                <span class="badge bg-success">Đã hoàn thành</span>
                                            {% else %}
                                                <span class="badge bg-warning">Đang xử lý</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>

                                {% if is_admin %}
                                    <div class="text-end mt-3">
                                        <a href="{% url 'registration:check_in_detail' check_in.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> Xem chi tiết
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Biên bản trả phòng -->
                {% if check_out %}
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Biên bản trả phòng</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 40%;">Ngày trả phòng:</th>
                                        <td>{{ check_out.check_out_date|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Trạng thái:</th>
                                        <td>
                                            {% if check_out.is_completed %}
                                                <span class="badge bg-success">Đã hoàn thành</span>
                                            {% else %}
                                                <span class="badge bg-warning">Đang xử lý</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% if check_out.is_completed %}
                                        <tr>
                                            <th>Tiền cọc hoàn trả:</th>
                                            <td>{{ check_out.deposit_refunded|intcomma }} VNĐ</td>
                                        </tr>
                                    {% endif %}
                                </table>

                                {% if is_admin %}
                                    <div class="text-end mt-3">
                                        <a href="{% url 'registration:check_out_detail' check_out.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> Xem chi tiết
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Hóa đơn liên quan -->
            {% if invoices %}
                <div class="card">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Hóa đơn liên quan</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Số hóa đơn</th>
                                        <th>Ngày lập</th>
                                        <th>Ngày đến hạn</th>
                                        <th>Tổng tiền</th>
                                        <th>Đã thanh toán</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invoice in invoices %}
                                        <tr>
                                            <td>{{ invoice.invoice_number }}</td>
                                            <td>{{ invoice.issue_date|date:"d/m/Y" }}</td>
                                            <td>{{ invoice.due_date|date:"d/m/Y" }}</td>
                                            <td>{{ invoice.total_amount|intcomma }} VNĐ</td>
                                            <td>{{ invoice.paid_amount|intcomma }} VNĐ</td>
                                            <td>
                                                {% if invoice.status == 'paid' %}
                                                    <span class="badge bg-success">Đã thanh toán</span>
                                                {% elif invoice.status == 'partially_paid' %}
                                                    <span class="badge bg-info">Thanh toán một phần</span>
                                                {% elif invoice.status == 'overdue' %}
                                                    <span class="badge bg-danger">Quá hạn</span>
                                                {% elif invoice.status == 'pending' %}
                                                    <span class="badge bg-warning">Chờ thanh toán</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ invoice.get_status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'payment:invoice_detail' invoice.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .contract-terms {
        font-size: 0.9rem;
    }

    .signature {
        margin-top: 60px;
        font-size: 2rem;
    }

    @media print {
        .no-print, .no-print * {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .card-header {
            background-color: white !important;
            border-bottom: 1px solid #000 !important;
        }

        .container-fluid {
            padding: 0 !important;
        }

        body {
            font-size: 12pt;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function printContract() {
        window.print();
    }
</script>
{% endblock %}